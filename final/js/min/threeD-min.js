function threeD(){function e(e,n){Q=e;var i=[];e.forEach(function(e,t){p=Z([e.longitude,e.latitude]),e.x=parseInt(p[0]),e.y=-parseInt(p[1]),e.xr=e.x+Math.random(),e.yr=e.y+Math.random(),e.percentage=parseInt(e.percentage),e.z=F(e.percentage),e.name=t,e.xx=parseInt(e.xx),e.yy=parseInt(e.yy),e.social=[],e.cube=null,i[e.xx]||(i[e.xx]=[]),i[e.xx][e.yy]=e}),n.forEach(function(e){var t=i[e.x][e.y];e.x=t.x,e.y=t.y,e.z=t.z,e.xr=t.xr,e.yr=t.yr,e.instagram*=1,e.twitter*=1,e.hour*=1,t.social[e.hour]={twitter:e.twitter,instagram:e.instagram}});var r=d3.nest().key(function(e){return e.bezirk}).entries(e),o=r.map(function(e){return u(e)}),c=d3.nest().key(function(e){return e.hour}).entries(n);N.on("click",function(){if(!d3.event.defaultPrevented){if(C.active==G){C.active=G=null,o.forEach(function(e){e.material.wireframe=!1,e.material.opacity=1,e.material.color.setHex(7261685),e.intersected=!1});var e=new TWEEN.Tween(H.position).to({x:0,y:0},1e3).easing(TWEEN.Easing.Quadratic.InOut).start(),e=new TWEEN.Tween({scale:W.scale()}).to({scale:1},1e3).onUpdate(function(e){W.scale(this.scale).event(N)}).easing(TWEEN.Easing.Quadratic.InOut).start()}if(G){var t=G.geometry.boundingBox.center().negate(),e=new TWEEN.Tween(H.position).to({x:t.x,y:t.y},1e3).easing(TWEEN.Easing.Quadratic.InOut).start(),e=new TWEEN.Tween({scale:W.scale()}).to({scale:3},1e3).onUpdate(function(e){W.scale(this.scale).event(N)}).easing(TWEEN.Easing.Quadratic.InOut).start();o.forEach(function(e){e.material.wireframe=!e.intersected,e.material.opacity=e.intersected?1:.6}),C.active=G}}});var s=0;d(e,s),t(),a()}function t(){f.forEach(function(e,t,n){var a=e.c,i=new THREE.SphereGeometry(10,10,10),r=new THREE.MeshBasicMaterial({color:16777215}),o=new THREE.Mesh(i,r);o.position.x=a[0],o.position.y=-a[1],o.position.z=100,o.visible=!1;var c=document.createElement("span");c.innerHTML=e.n,o.domlabel=document.createElement("div"),o.domlabel.appendChild(c),o.domlabel.style.display="none",o.domlabel.style.position="absolute",document.getElementById("labels").appendChild(o.domlabel),H.add(o),U.push(o)})}function n(){V.setFromCamera(D,M);var e=V.intersectObjects(H.children);e.length>0?G!=e[0].object&&e[0].object.hasOwnProperty("bezirk")&&(G&&(G.material.color.setHex(G.currentHex),G.position.z=0,G.material.wireframe=!1,G.intersected=!1),G=e[0].object,G.intersected=!0,G.currentHex=G.material.color.getHex(),G.material.color.setHex(15073330),G.material.wireframe=!1,v.style.cursor="pointer"):(G&&(G.material.color.setHex(G.currentHex),G.position.z=0,G.material.wireframe=!1,G.intersected=!1),G=null,v.style.cursor="inherit")}function a(e){TWEEN.update(),i(e)}function i(e){z.rotation.z+=.001,s(U),r(e),c(),x.render(T,M),E&&(x.domElement.toBlob(function(e){saveAs(e,"breitband.png")}),E=!1)}function r(e){var t=parseInt(e/X)%24;t!=Y&&(Y=t,o(Y))}function o(e){h.text((10>e?"0"+e:e)+":00"),Q.forEach(function(t){var n=t.social[e],a=.2,i=.2,r=J-t.z;n&&(C.instagram&&(a=r+L(n.instagram)),C.twitter&&(i=r+L(n.twitter))),t.cube&&(t.cube.animateZ=a),t.cube2&&(t.cube2.animateZ=i)})}function c(){Q.forEach(function(e){e.cube&&(e.cube.position.z+=(e.z-10+e.cube.animateZ-e.cube.position.z)*q,e.cube.scale.z=e.cube.scale.x=e.cube.scale.y+=(e.cube.animateZ/10-e.cube.scale.z)*q),e.cube2&&(e.cube2.position.z+=(e.z-10+e.cube2.animateZ-e.cube2.position.z)*q,e.cube2.scale.z=e.cube2.scale.x=e.cube2.scale.y+=(e.cube2.animateZ/10-e.cube2.scale.z)*q)})}function s(e){for(var t=0;t<e.length;t++){var n=(new THREE.Vector3).setFromMatrixPosition(e[t].matrixWorld).project(M);e[t].domlabel.style.display="block",e[t].domlabel.style.transform="translate("+(n.x+1)/2*g+"px,"+(-n.y+1)/2*w+"px)"}}function l(e,t,n){var a=e.filter(function(e){return e.hour==n})[0];return a?L(a[t]):0}function d(e,t){var n=new THREE.BoxGeometry(5,5,5);n.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,.5));var a=new THREE.MeshLambertMaterial({color:15073330,opacity:.9,transparent:!1}),i=new THREE.MeshLambertMaterial({color:13956702,opacity:.9,transparent:!1}),r=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.8,fog:!1});e.forEach(function(e){if(e.social.filter(function(e){return 0!=e.instagram}).length>0){var t=new THREE.Mesh(n,a);t.position.x=e.x,t.position.y=e.y,t.position.z=e.z,t.visible=!0,e.cube=t,H.add(t)}e.social.filter(function(e){return 0!=e.twitter}).length>0&&(t=new THREE.Mesh(n,i),t.position.x=e.x+10,t.position.y=e.y,t.position.z=e.z,t.visible=!0,e.cube2=t,H.add(t))})}function u(e){var t=e.values,n=O.triangles(t),a=new THREE.Geometry;a.vertices=t.map(function(e,t){return e.id=t,new THREE.Vector3(e.x,e.y,e.z)}),n.forEach(function(e){var t=(Math.abs(e[0].x-e[1].x)+Math.abs(e[1].x-e[2].x)+Math.abs(e[0].x-e[2].x))/3,n=(Math.abs(e[0].y-e[1].y)+Math.abs(e[1].y-e[2].y)+Math.abs(e[0].y-e[2].y))/3;t>20||n>20||a.faces.push(new THREE.Face3(e[0].id,e[1].id,e[2].id))}),a.computeFaceNormals(),a.computeBoundingBox();var i=new THREE.MeshLambertMaterial({color:7261685,side:THREE.BackSide,wireframe:!1,transparent:!0}),r=new THREE.Mesh(a,i);return r.bezirk=e.key,H.add(r),r}function m(e){for(var t=atob(e.split(",")[1]),n=e.split(",")[0].split(":")[1].split(";")[0],a=new ArrayBuffer(t.length),i=new Uint8Array(a),r=0;r<t.length;r++)i[r]=t.charCodeAt(r);var o=new DataView(a),c=new Blob([o],{type:n});return c}var f=[{c:[-164.94678225444946,-63.029871437100326],n:"Mitte"},{c:[52.778130057326905,103.42041724165729],n:"Friedrichshain-Kreuzberg"},{c:[94.44270055577594,-432.5721103772772],n:"Pankow"},{c:[-499.09505521863184,119.66473570559107],n:"Charlottenburg-Wilmersdorf"},{c:[-818.1448708597577,-22.566868616095963],n:"Spandau"},{c:[-607.8190923800062,498.97261500635307],n:"Steglitz-Zehlendorf"},{c:[-113.29687363849465,462.53109998602974],n:"Tempelhof-Schöneberg"},{c:[145.7122760209756,463.22536731944496],n:"Neukölln"},{c:[691.0693806464119,528.9735270041073],n:"Treptow-Köpenick"},{c:[578.0995751704685,4.466256221793847],n:"Marzahn-Hellersdorf"},{c:[337.0342485538481,-74.80341059918459],n:"Lichtenberg"},{c:[-425.4280684254382,-423.6349448086686],n:"Reinickendorf"}];d3.select(window).on("resize",function(){clearTimeout(window.resizedFinished),window.resizedFinished=setTimeout(function(){b()},250)}),d3.select(".fullscreen").on("click",function(e){screenfull.toggle(),d3.select(this).classed("active",screenfull.isFullscreen)}).style("display",function(){return screenfull.enabled}),d3.select(".instagram").on("click",function(e){C.instagram=!C.instagram,d3.select(this).classed("active",C.instagram)}),d3.select(".twitter").on("click",function(e){C.twitter=!C.twitter,d3.select(this).classed("active",C.twitter)}),d3.select(".menu .screenshot").on("click",function(e){E=!0});var E=!1,h=d3.select(".time .clock"),b=function(){var e=d3.select("#container").node().getBoundingClientRect();g=e.width,w=e.height,M.aspect=g/w,M.updateProjectionMatrix(),x.setSize(g,w)},y=d3.select("#container").node().getBoundingClientRect(),g=y.width,w=y.height,v=document.getElementById("container"),x=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!0});x.setClearColor(1980305),x.setSize(g,w),v.appendChild(x.domElement);var T=new THREE.Scene,z=new THREE.Scene,H=new THREE.Scene;T.add(z),z.add(H),T.add(new THREE.HemisphereLight(16777215,1980305));var R=new THREE.DirectionalLight(16777215,1);R.position.set(1,100,300),T.add(R);var M=new THREE.PerspectiveCamera(50,g/w,1,1e4);M.position.x=0,M.position.y=-2e3,M.position.z=1200,M.lookAt(T.position);var k=d3.behavior.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}).on("drag",function(e){z.rotation.z+=d3.event.dx/100}),B=(new THREE.Vector3).copy(M.position),W=d3.behavior.zoom().scale(1).scaleExtent([1,5]).on("zoom",function(e){M.position.y=B.y/d3.event.scale,M.position.z=B.z/d3.event.scale,M.lookAt(T.position)}),I=W.scale(),N=d3.select(x.domElement).datum({drag:!1}).call(k).call(W).on("mousemove",function(){D.x=event.clientX/g*2-1,D.y=2*-(event.clientY/w)+1,C.active||n()}),C={active:null,twitter:!0,instagram:!0},S=d3.time.format("%Y-%m-%d").parse,F=d3.scale.linear().range([1,50]).domain([0,5]),L=d3.scale.log().range([1,200]).domain([1,50]),j=d3.scale.log().range(["#fff","#ddd"]).domain([1,200]),P=[13.413215,52.521918],Z=d3.geo.mercator().scale(2e5).center(P).translate([0,0]),A=d3.geo.path().projection(Z),O=d3.geom.voronoi().x(function(e){return e.xr}).y(function(e){return e.yr}),V=new THREE.Raycaster,D=new THREE.Vector2,G,Q;d3.csv("data/50mbit.csv",function(t,n){d3.csv("data/dataNEW.csv",function(t,a){e(n,a)})});var U=[],K=0,Y=0,X=400,q=.05,J=60}