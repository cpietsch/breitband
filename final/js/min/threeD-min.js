function threeD(){function e(){}function t(e,t){K=e;var a=[];e.forEach(function(e,t){var n=Z([e.longitude,e.latitude]);e.x=parseInt(n[0]),e.y=-parseInt(n[1]),e.xr=e.x+Math.random(),e.yr=e.y+Math.random(),e.percentage=parseInt(e.percentage),e.z=L(e.percentage),e.name=t,e.xx=parseInt(e.xx),e.yy=parseInt(e.yy),e.social=[],e.cube=null,a[e.xx]||(a[e.xx]=[]),a[e.xx][e.yy]=e}),t.forEach(function(e){var t=a[e.x][e.y];e.x=t.x,e.y=t.y,e.z=t.z,e.xr=t.xr,e.yr=t.yr,e.instagram*=1,e.twitter*=1,e.hour*=1,t.social[e.hour]={twitter:e.twitter,instagram:e.instagram}}),j=d3.scale.linear().range([100,150]).domain([0,d3.max(t,function(e){return e.twitter})]),A=d3.scale.linear().range([100,150]).domain([0,d3.max(t,function(e){return e.instagram})]);var i=d3.nest().key(function(e){return e.bezirk}).entries(e),r=i.map(function(e){return m(e)}),c=d3.nest().key(function(e){return e.hour}).entries(t);N.on("click",function(){if(!d3.event.defaultPrevented){if(D.active===U){D.active=U=null,r.forEach(function(e){e.material.wireframe=!1,e.material.opacity=1,e.material.color.setHex(7261685),e.intersected=!1});var e=new TWEEN.Tween(H.position).to({x:0,y:0},1e3).easing(TWEEN.Easing.Quadratic.InOut).start(),t=new TWEEN.Tween({scale:W.scale()}).to({scale:1},1e3).onUpdate(function(e){W.scale(this.scale).event(N)}).easing(TWEEN.Easing.Quadratic.InOut).start()}if(U){var n=U.geometry.boundingBox.center().negate(),a=new TWEEN.Tween(H.position).to({x:n.x,y:n.y},1e3).easing(TWEEN.Easing.Quadratic.InOut).start(),i=new TWEEN.Tween({scale:W.scale()}).to({scale:3},1e3).onUpdate(function(e){W.scale(this.scale).event(N)}).easing(TWEEN.Easing.Quadratic.InOut).start();r.forEach(function(e){e.material.wireframe=!e.intersected,e.material.opacity=e.intersected?1:.6}),D.active=U}}});var s=0;p(e,s),n(),o()}function n(){E.forEach(function(e,t,n){var a=e.c,i=new THREE.SphereGeometry(10,10,10),r=new THREE.MeshBasicMaterial({color:16777215}),o=new THREE.Mesh(i,r);o.position.x=a[0],o.position.y=-a[1],o.position.z=100,o.visible=!1;var c=document.createElement("span");c.innerHTML=e.n,o.domlabel=document.createElement("div"),o.domlabel.appendChild(c),o.domlabel.style.display="none",document.getElementById("labels").appendChild(o.domlabel),H.add(o),Y.push(o)})}function a(){G.setFromCamera(Q,S);var e=G.intersectObjects(H.children);e.length>0?U!==e[0].object&&e[0].object.hasOwnProperty("bezirk")&&(U&&(U.material.color.setHex(U.currentHex),U.position.z=0,U.material.wireframe=!1,U.intersected=!1),U=e[0].object,U.intersected=!0,U.currentHex=U.material.color.getHex(),U.material.color.setHex(15073330),U.material.wireframe=!1,w.style.cursor="pointer"):(U&&(U.material.color.setHex(U.currentHex),U.position.z=0,U.material.wireframe=!1,U.intersected=!1),U=null,w.style.cursor="inherit")}function i(e){(D.play||screenfull.isFullscreen)&&(requestAnimationFrame(i),TWEEN.update(),o(e))}function r(){K.forEach(function(e){e.cube&&(D.instagram?e.cube.visible=!0:e.cube.visible=!1),e.cube2&&(D.twitter?e.cube2.visible=!0:e.cube2.visible=!1)})}function o(e){z.rotation.z+=.001,u(Y),(D.twitter||D.instagram)&&(c(e),l()),x.render(T,S),y&&(x.domElement.toBlob(function(e){saveAs(e,"breitband.png")}),y=!1)}function c(e){var t=parseInt(e/X)%24;t!==J&&(J=t,s(J))}function s(e){b.text((10>e?"0"+e:e)+":00"),K.forEach(function(t){var n=t.social[e],a=.2,i=.2,r=ee-t.z;n&&(D.instagram&&(a=r+A(n.instagram)),D.twitter&&(i=r+j(n.twitter))),t.cube&&(t.cube.animateZ=a),t.cube2&&(t.cube2.animateZ=i)})}function l(){K.forEach(function(e){e.cube&&(e.cube.position.z+=(e.z-10+e.cube.animateZ-e.cube.position.z)*_,e.cube.scale.z=e.cube.scale.x=e.cube.scale.y+=(e.cube.animateZ/20-e.cube.scale.z)*_),e.cube2&&(e.cube2.position.z+=(e.z-10+e.cube2.animateZ-e.cube2.position.z)*_,e.cube2.scale.z=e.cube2.scale.x=e.cube2.scale.y+=(e.cube2.animateZ/20-e.cube2.scale.z)*_)})}function u(e){for(var t=0;t<e.length;t++){var n=d(e[t]);e[t].domlabel.style.display="block",e[t].domlabel.style.transform="translate("+n.x+"px,"+n.y+"px)"}}function d(e){var t=(new THREE.Vector3).setFromMatrixPosition(e.matrixWorld).project(S),n=(t.x+1)/2*g,a=(-t.y+1)/2*v;return{x:n,y:a}}function p(e,t){var n=new THREE.BoxGeometry(5,5,5);n.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,.5));var a=new THREE.MeshLambertMaterial({color:5091146,opacity:.9,transparent:!1}),i=new THREE.MeshLambertMaterial({color:15073330,opacity:.9,transparent:!1}),o=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.8,fog:!1});e.forEach(function(e){var t;e.social.filter(function(e){return 0!==e.instagram}).length>0&&(t=new THREE.Mesh(n,a),t.position.x=e.x,t.position.y=e.y,t.position.z=e.z,t.visible=!0,e.cube=t,H.add(t)),e.social.filter(function(e){return 0!==e.twitter}).length>0&&(t=new THREE.Mesh(n,i),t.position.x=e.x+10,t.position.y=e.y,t.position.z=e.z,t.visible=!0,e.cube2=t,H.add(t))}),r()}function m(e){var t=e.values,n=V.triangles(t),a=new THREE.Geometry;a.vertices=t.map(function(e,t){return e.id=t,new THREE.Vector3(e.x,e.y,e.z)}),n.forEach(function(e){var t=(Math.abs(e[0].x-e[1].x)+Math.abs(e[1].x-e[2].x)+Math.abs(e[0].x-e[2].x))/3,n=(Math.abs(e[0].y-e[1].y)+Math.abs(e[1].y-e[2].y)+Math.abs(e[0].y-e[2].y))/3;t>20||n>20||a.faces.push(new THREE.Face3(e[0].id,e[1].id,e[2].id))}),a.computeFaceNormals(),a.computeBoundingBox();var i=new THREE.MeshLambertMaterial({color:7261685,side:THREE.BackSide,wireframe:!1,transparent:!0}),r=new THREE.Mesh(a,i);return r.bezirk=e.key,H.add(r),r}function f(e){for(var t=atob(e.split(",")[1]),n=e.split(",")[0].split(":")[1].split(";")[0],a=new ArrayBuffer(t.length),i=new Uint8Array(a),r=0;r<t.length;r++)i[r]=t.charCodeAt(r);var o=new DataView(a),c=new Blob([o],{type:n});return c}var E=[{c:[-164.94678225444946,-63.029871437100326],n:"Mitte"},{c:[52.778130057326905,103.42041724165729],n:"Friedrichshain-Kreuzberg"},{c:[94.44270055577594,-432.5721103772772],n:"Pankow"},{c:[-499.09505521863184,119.66473570559107],n:"Charlottenburg-Wilmersdorf"},{c:[-818.1448708597577,-22.566868616095963],n:"Spandau"},{c:[-607.8190923800062,498.97261500635307],n:"Steglitz-Zehlendorf"},{c:[-113.29687363849465,462.53109998602974],n:"Tempelhof-Schöneberg"},{c:[145.7122760209756,463.22536731944496],n:"Neukölln"},{c:[691.0693806464119,528.9735270041073],n:"Treptow-Köpenick"},{c:[578.0995751704685,4.466256221793847],n:"Marzahn-Hellersdorf"},{c:[337.0342485538481,-74.80341059918459],n:"Lichtenberg"},{c:[-425.4280684254382,-423.6349448086686],n:"Reinickendorf"}];d3.select(".company-help").on("click",function(){d3.select(".company-help").style("display","none")}),d3.select(".infobtn").on("click",function(){d3.select(".company-help").style("display","block")}),d3.select(".instagram").on("click",function(t){D.instagram=!D.instagram,d3.select(this).classed("active",D.instagram),e.updateSocialStatus()}),d3.select(".twitter").on("click",function(t){D.twitter=!D.twitter,d3.select(this).classed("active",D.twitter),e.updateSocialStatus()}),d3.select(".menu .screenshot").on("click",function(e){y=!0});var y=!1,b=d3.select(".time .clock");e.updateSocialStatus=function(){D.twitter||D.instagram?d3.select(".time").style("display","block"):d3.select(".time").style("display","none"),r()},e.resize=function(){var e=d3.select("#container").node().getBoundingClientRect();g=e.width,v=e.height,S.aspect=g/v,S.updateProjectionMatrix(),x.setSize(g,v)},e.play=function(){D.play||(D.play=!0,i())},e.pause=function(){D.play=!1},d3.select(".fullscreen").on("click",function(t){screenfull.toggle(),e.play(),d3.select(this).classed("active",screenfull.isFullscreen)}).style("display",function(){return screenfull.enabled});var h=d3.select("#container").node().getBoundingClientRect(),g=h.width,v=h.height,w=document.getElementById("container"),x=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!1});x.setClearColor(1980305),x.setSize(g,v),w.appendChild(x.domElement);var T=new THREE.Scene,z=new THREE.Scene,H=new THREE.Scene;T.add(z),z.add(H);var R=new Date,M=new Date;M.setDate(R.getDate()-1),d3.select(".date").text((M.getDate()<10?"0":"")+M.getDate()+"."+(M.getMonth()<10?"0":"")+M.getMonth()+"."+M.getFullYear()),T.add(new THREE.HemisphereLight(16777215,1980305));var k=new THREE.DirectionalLight(16777215,1);k.position.set(1,100,300),T.add(k);var S=new THREE.PerspectiveCamera(50,g/v,1,1e4);S.position.x=0,S.position.y=-1800,S.position.z=1100,S.lookAt(T.position);var B=d3.behavior.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}).on("drag",function(e){z.rotation.z+=d3.event.dx/100}),I=(new THREE.Vector3).copy(S.position),W=d3.behavior.zoom().scaleExtent([1,5]).on("zoom",function(e){S.position.y=I.y/d3.event.scale,S.position.z=I.z/d3.event.scale,S.lookAt(T.position)}),C=W.scale(),N=d3.select(x.domElement).datum({drag:!1}).call(B).call(W).on("mousemove",function(){var e=d3.mouse(this);Q.x=e[0]/g*2-1,Q.y=2*-(e[1]/v)+1,D.active||a()}),D={fullscreen:!1,play:!1,active:null,twitter:!1,instagram:!1},F=d3.time.format("%Y-%m-%d").parse,L=d3.scale.linear().range([1,50]).domain([0,5]),j,A,P=[13.413215,52.521918],Z=d3.geo.mercator().scale(24e4).center(P).translate([0,0]),O=d3.geo.path().projection(Z),V=d3.geom.voronoi().x(function(e){return e.xr}).y(function(e){return e.yr}),G=new THREE.Raycaster,Q=new THREE.Vector2,U,K;d3.csv("data/50mbit.csv",function(e,n){d3.csv("http://tsb.sebastianmeier.eu/static/data.csv",function(e,a){t(n,a)})});var Y=[],q=0,J=0,X=400,_=.05,ee=60;try{window.self!==window.top||(D.play=!0,i())}catch(te){}return e}