function threeD(){function e(e,n){U=e;var i=[];e.forEach(function(e,t){p=A([e.longitude,e.latitude]),e.x=parseInt(p[0]),e.y=-parseInt(p[1]),e.xr=e.x+Math.random(),e.yr=e.y+Math.random(),e.percentage=parseInt(e.percentage),e.z=L(e.percentage),e.name=t,e.xx=parseInt(e.xx),e.yy=parseInt(e.yy),e.social=[],e.cube=null,i[e.xx]||(i[e.xx]=[]),i[e.xx][e.yy]=e}),n.forEach(function(e){var t=i[e.x][e.y];e.x=t.x,e.y=t.y,e.z=t.z,e.xr=t.xr,e.yr=t.yr,e.instagram*=1,e.twitter*=1,e.hour*=1,t.social[e.hour]={twitter:e.twitter,instagram:e.instagram}});var r=d3.nest().key(function(e){return e.bezirk}).entries(e),o=r.map(function(e){return m(e)}),c=d3.nest().key(function(e){return e.hour}).entries(n);C.on("click",function(){if(!d3.event.defaultPrevented){if(S.active==Q){S.active=Q=null,o.forEach(function(e){e.material.wireframe=!1,e.material.opacity=1,e.material.color.setHex(7261685),e.intersected=!1});var e=new TWEEN.Tween(R.position).to({x:0,y:0},1e3).easing(TWEEN.Easing.Quadratic.InOut).start();console.log(I.scale());var e=new TWEEN.Tween({scale:I.scale()}).to({scale:1},1e3).onUpdate(function(e){I.scale(this.scale).event(C),console.log(I.scale())}).easing(TWEEN.Easing.Quadratic.InOut).start()}if(Q){var t=Q.geometry.boundingBox.center().negate(),e=new TWEEN.Tween(R.position).to({x:t.x,y:t.y},1e3).easing(TWEEN.Easing.Quadratic.InOut).start();console.log(I.scale());var e=new TWEEN.Tween({scale:I.scale()}).to({scale:3},1e3).onUpdate(function(e){I.scale(this.scale).event(C),console.log(I.scale())}).easing(TWEEN.Easing.Quadratic.InOut).start();o.forEach(function(e){e.material.wireframe=!e.intersected,e.material.opacity=e.intersected?1:.6}),S.active=Q}}});var s=0;d(e,s),t(),a()}function t(){E.forEach(function(e,t,n){var a=e.c,i=new THREE.SphereGeometry(10,10,10),r=new THREE.MeshBasicMaterial({color:16777215}),o=new THREE.Mesh(i,r);o.position.x=a[0],o.position.y=-a[1],o.position.z=100,o.visible=!1;var c=document.createElement("span");c.innerHTML=e.n,o.domlabel=document.createElement("div"),o.domlabel.appendChild(c),o.domlabel.style.display="none",o.domlabel.style.position="absolute",document.getElementById("labels").appendChild(o.domlabel),R.add(o),K.push(o)})}function n(){D.setFromCamera(G,k);var e=D.intersectObjects(R.children);e.length>0?Q!=e[0].object&&e[0].object.hasOwnProperty("bezirk")&&(Q&&(Q.material.color.setHex(Q.currentHex),Q.position.z=0,Q.material.wireframe=!1,Q.intersected=!1),Q=e[0].object,Q.intersected=!0,Q.currentHex=Q.material.color.getHex(),Q.material.color.setHex(15073330),Q.material.wireframe=!1,x.style.cursor="pointer"):(Q&&(Q.material.color.setHex(Q.currentHex),Q.position.z=0,Q.material.wireframe=!1,Q.intersected=!1),Q=null,x.style.cursor="inherit")}function a(e){TWEEN.update(),r(e)}function i(){U.forEach(function(e){e.cube&&(S.instagram?e.cube.visible=!0:e.cube.visible=!1),e.cube2&&(S.twitter?e.cube2.visible=!0:e.cube2.visible=!1)})}function r(e){H.rotation.z+=.001,l(K),(S.twitter||S.instagram)&&(o(e),s()),T.render(z,k),b&&(T.domElement.toBlob(function(e){saveAs(e,"breitband.png")}),b=!1)}function o(e){var t=parseInt(e/q)%24;t!=X&&(X=t,c(X))}function c(e){h.text((10>e?"0"+e:e)+":00"),U.forEach(function(t){var n=t.social[e],a=.2,i=.2,r=_-t.z;n&&(S.instagram&&(a=r+j(n.instagram)),S.twitter&&(i=r+j(n.twitter))),t.cube&&(t.cube.animateZ=a),t.cube2&&(t.cube2.animateZ=i)})}function s(){U.forEach(function(e){e.cube&&(e.cube.position.z+=(e.z-10+e.cube.animateZ-e.cube.position.z)*J,e.cube.scale.z=e.cube.scale.x=e.cube.scale.y+=(e.cube.animateZ/10-e.cube.scale.z)*J),e.cube2&&(e.cube2.position.z+=(e.z-10+e.cube2.animateZ-e.cube2.position.z)*J,e.cube2.scale.z=e.cube2.scale.x=e.cube2.scale.y+=(e.cube2.animateZ/10-e.cube2.scale.z)*J)})}function l(e){for(var t=0;t<e.length;t++){var n=(new THREE.Vector3).setFromMatrixPosition(e[t].matrixWorld).project(k);e[t].domlabel.style.display="block",e[t].domlabel.style.transform="translate("+(n.x+1)/2*w+"px,"+(-n.y+1)/2*y+"px)"}}function u(e,t,n){var a=e.filter(function(e){return e.hour==n})[0];return a?j(a[t]):0}function d(e,t){var n=new THREE.BoxGeometry(5,5,5);n.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,.5));var a=new THREE.MeshLambertMaterial({color:15073330,opacity:.9,transparent:!1}),r=new THREE.MeshLambertMaterial({color:13956702,opacity:.9,transparent:!1}),o=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.8,fog:!1});e.forEach(function(e){if(e.social.filter(function(e){return 0!=e.instagram}).length>0){var t=new THREE.Mesh(n,a);t.position.x=e.x,t.position.y=e.y,t.position.z=e.z,t.visible=!0,e.cube=t,R.add(t)}e.social.filter(function(e){return 0!=e.twitter}).length>0&&(t=new THREE.Mesh(n,r),t.position.x=e.x+10,t.position.y=e.y,t.position.z=e.z,t.visible=!0,e.cube2=t,R.add(t))}),i()}function m(e){var t=e.values,n=V.triangles(t),a=new THREE.Geometry;a.vertices=t.map(function(e,t){return e.id=t,new THREE.Vector3(e.x,e.y,e.z)}),n.forEach(function(e){var t=(Math.abs(e[0].x-e[1].x)+Math.abs(e[1].x-e[2].x)+Math.abs(e[0].x-e[2].x))/3,n=(Math.abs(e[0].y-e[1].y)+Math.abs(e[1].y-e[2].y)+Math.abs(e[0].y-e[2].y))/3;t>20||n>20||a.faces.push(new THREE.Face3(e[0].id,e[1].id,e[2].id))}),a.computeFaceNormals(),a.computeBoundingBox();var i=new THREE.MeshLambertMaterial({color:7261685,side:THREE.BackSide,wireframe:!1,transparent:!0}),r=new THREE.Mesh(a,i);return r.bezirk=e.key,R.add(r),r}function f(e){for(var t=atob(e.split(",")[1]),n=e.split(",")[0].split(":")[1].split(";")[0],a=new ArrayBuffer(t.length),i=new Uint8Array(a),r=0;r<t.length;r++)i[r]=t.charCodeAt(r);var o=new DataView(a),c=new Blob([o],{type:n});return c}var E=[{c:[-164.94678225444946,-63.029871437100326],n:"Mitte"},{c:[52.778130057326905,103.42041724165729],n:"Friedrichshain-Kreuzberg"},{c:[94.44270055577594,-432.5721103772772],n:"Pankow"},{c:[-499.09505521863184,119.66473570559107],n:"Charlottenburg-Wilmersdorf"},{c:[-818.1448708597577,-22.566868616095963],n:"Spandau"},{c:[-607.8190923800062,498.97261500635307],n:"Steglitz-Zehlendorf"},{c:[-113.29687363849465,462.53109998602974],n:"Tempelhof-Schöneberg"},{c:[145.7122760209756,463.22536731944496],n:"Neukölln"},{c:[691.0693806464119,528.9735270041073],n:"Treptow-Köpenick"},{c:[578.0995751704685,4.466256221793847],n:"Marzahn-Hellersdorf"},{c:[337.0342485538481,-74.80341059918459],n:"Lichtenberg"},{c:[-425.4280684254382,-423.6349448086686],n:"Reinickendorf"}];d3.select(window).on("resize",function(){clearTimeout(window.resizedFinished),window.resizedFinished=setTimeout(function(){g()},250)}),d3.select(".fullscreen").on("click",function(e){screenfull.toggle(),d3.select(this).classed("active",screenfull.isFullscreen)}).style("display",function(){return screenfull.enabled}),d3.select(".instagram").on("click",function(e){S.instagram=!S.instagram,d3.select(this).classed("active",S.instagram)}),d3.select(".twitter").on("click",function(e){S.twitter=!S.twitter,d3.select(this).classed("active",S.twitter)}),d3.select(".menu .screenshot").on("click",function(e){b=!0});var b=!1,h=d3.select(".time .clock"),g=function(){var e=d3.select("#container").node().getBoundingClientRect();w=e.width,y=e.height,k.aspect=w/y,k.updateProjectionMatrix(),T.setSize(w,y)},v=d3.select("#container").node().getBoundingClientRect(),w=v.width,y=v.height,x=document.getElementById("container"),T=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!0});T.setClearColor(1980305),T.setSize(w,y),x.appendChild(T.domElement);var z=new THREE.Scene,H=new THREE.Scene,R=new THREE.Scene;z.add(H),H.add(R),z.add(new THREE.HemisphereLight(16777215,1980305));var M=new THREE.DirectionalLight(16777215,1);M.position.set(1,100,300),z.add(M);var k=new THREE.PerspectiveCamera(50,w/y,1,1e4);k.position.x=0,k.position.y=-2e3,k.position.z=1200,k.lookAt(z.position);var B=d3.behavior.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}).on("drag",function(e){H.rotation.z+=d3.event.dx/100}),W=(new THREE.Vector3).copy(k.position),I=d3.behavior.zoom().scale(1.5).scaleExtent([1.5,5]).on("zoom",function(e){k.position.y=W.y/d3.event.scale,k.position.z=W.z/d3.event.scale,k.lookAt(z.position)}),N=I.scale(),C=d3.select(T.domElement).datum({drag:!1}).call(B).call(I).on("mousemove",function(){G.x=event.clientX/w*2-1,G.y=2*-(event.clientY/y)+1,S.active||n()}),S={active:null,twitter:!1,instagram:!1},F=d3.time.format("%Y-%m-%d").parse,L=d3.scale.linear().range([1,50]).domain([0,5]),j=d3.scale.log().range([1,200]).domain([1,50]),P=d3.scale.log().range(["#fff","#ddd"]).domain([1,200]),Z=[13.413215,52.521918],A=d3.geo.mercator().scale(2e5).center(Z).translate([0,0]),O=d3.geo.path().projection(A),V=d3.geom.voronoi().x(function(e){return e.xr}).y(function(e){return e.yr}),D=new THREE.Raycaster,G=new THREE.Vector2,Q,U;d3.csv("data/50mbit.csv",function(t,n){d3.csv("data/dataNEW.csv",function(t,a){e(n,a)})});var K=[],Y=0,X=0,q=400,J=.05,_=60}